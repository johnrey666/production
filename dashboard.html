<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CTK | Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="assets/style.css">
  <script src="assets/script.js" defer></script>
</head>
<body>

<div class="app">
  <aside id="sidebar" class="sidebar"></aside>
  <div class="sidebar-overlay"></div>

  <main class="main">
    <header class="header">
      <div class="header-left">
        <button class="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1>Production Dashboard</h1>
      </div>
      <div class="header-actions">
        <span id="todayDate"></span>
        <button class="btn" onclick="logout()" style="background: var(--danger);">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>
    
    <div class="content">
      <div class="stats">
        <div class="stat"><div class="stat-value">68</div><div class="stat-label">Batches Today</div></div>
        <div class="stat"><div class="stat-value">2,847 kg</div><div class="stat-label">Total Output</div></div>
        <div class="stat"><div class="stat-value">₱892,450</div><div class="stat-label">Raw Mat Cost</div></div>
        <div class="stat"><div class="stat-value positive">+12.4 kg</div><div class="stat-label">Net Variance</div></div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">Today's Summary</div></div>
        <div class="card-body">
          <p>All systems running smoothly. Production on track.</p>
          <p><strong>Top Product:</strong> Pork BBQ • <strong>Wastage Alert:</strong> None</p>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  // Set today's date in the header
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const todayDateEl = document.getElementById('todayDate');
    if (todayDateEl) {
      todayDateEl.textContent = today.toLocaleDateString('en-PH', options);
    }
  });
  
  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      window.location.href = 'index.html';
    }
  }

  
/* -------------------
   dashboard.html code
   ------------------- */
function initDashboard() {
  console.log('Initializing dashboard...');
  
  // Set today's date in the header if element exists
  const todayDateEl = document.getElementById('todayDate');
  if (todayDateEl) {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    todayDateEl.textContent = today.toLocaleDateString('en-PH', options);
  }
  
  // Load dashboard stats from localStorage if available
  loadDashboardStats();
}

function loadDashboardStats() {
  // Try to load real data from production records
  const prodDB = JSON.parse(localStorage.getItem('ctk_prod')) || {};
  const today = new Date().toISOString().split('T')[0];
  const todayData = prodDB[today] || [];
  
  let batchesToday = 0;
  let totalOutput = 0;
  let totalCost = 0;
  let netVariance = 0;
  
  todayData.forEach(entry => {
    batchesToday += entry.batches || 0;
    totalOutput += entry.output || 0;
    
    // Calculate cost (simplified - you might want more complex logic)
    const recipes = JSON.parse(localStorage.getItem('ctk_recipes')) || [];
    const recipe = recipes.find(r => r.name === entry.product);
    if (recipe) {
      const rawMaterials = JSON.parse(localStorage.getItem('ctk_mats')) || [];
      let recipeCost = 0;
      recipe.ingredients.forEach(ing => {
        const mat = rawMaterials.find(m => m.sku === ing.sku);
        if (mat) {
          recipeCost += (ing.qty || 0) * (entry.batches || 0) * (mat.perkg || 0);
        }
      });
      totalCost += recipeCost;
    }
    
    // Calculate variance
    const expectedOutput = (entry.batches || 0) * (recipe?.yieldKg || 0);
    netVariance += (entry.output || 0) - expectedOutput;
  });
  
  // Update dashboard stats if elements exist
  const batchesEl = document.querySelector('.stat:nth-child(1) .stat-value');
  const outputEl = document.querySelector('.stat:nth-child(2) .stat-value');
  const costEl = document.querySelector('.stat:nth-child(3) .stat-value');
  const varianceEl = document.querySelector('.stat:nth-child(4) .stat-value');
  
  if (batchesEl && batchesToday > 0) batchesEl.textContent = batchesToday;
  if (outputEl && totalOutput > 0) outputEl.textContent = totalOutput.toFixed(0) + ' kg';
  if (costEl && totalCost > 0) costEl.textContent = '₱' + totalCost.toFixed(0);
  if (varianceEl) {
    varianceEl.textContent = (netVariance >= 0 ? '+' : '') + netVariance.toFixed(1) + ' kg';
    varianceEl.className = netVariance >= 0 ? 'stat-value positive' : 'stat-value negative';
  }
  
  // Update summary
  const summaryEl = document.querySelector('.card-body');
  if (summaryEl && todayData.length > 0) {
    // Find top product
    const productCount = {};
    todayData.forEach(entry => {
      if (entry.product) {
        productCount[entry.product] = (productCount[entry.product] || 0) + (entry.batches || 0);
      }
    });
    
    const topProduct = Object.entries(productCount).sort((a, b) => b[1] - a[1])[0];
    const hasWastage = netVariance < 0;
    
    summaryEl.innerHTML = `
      <p>${todayData.length > 0 ? 'Production data loaded for today.' : 'No production data for today.'}</p>
      <p><strong>Top Product:</strong> ${topProduct ? topProduct[0] : 'None'} • <strong>Wastage Alert:</strong> ${hasWastage ? 'Yes' : 'None'}</p>
    `;
  }
}
</script>
</body>
</html>